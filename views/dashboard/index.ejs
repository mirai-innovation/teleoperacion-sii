<%
  // Pre-process JSON data for JavaScript - safe stringification
  const historyDataJson = typeof historyData !== 'undefined' && historyData.length > 0 
    ? JSON.stringify(historyData) 
    : '[]';
  const chartDataJson = typeof chartData !== 'undefined' && chartData.length > 0 
    ? JSON.stringify(chartData) 
    : '[]';
  
  // Helper function to escape HTML attributes safely
  function escapeAttr(str) {
    if (!str) return '';
    return String(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  
  // Build CSS content
  let cssContent = '<style>.dashboard-main-grid{display:grid;grid-template-columns:8fr 4fr;gap:24px;margin-top:24px}.dashboard-left-column{display:flex;flex-direction:column;gap:24px}.next-session-banner{background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px 24px;border-top:3px solid var(--neon-cyan);display:flex;align-items:center;justify-content:space-between;transition:all 0.3s ease}.next-session-banner:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 4px 16px rgba(41,182,246,0.2)}.next-session-content{display:flex;align-items:center;gap:16px}.next-session-icon{font-size:2rem;color:var(--neon-cyan)}.next-session-text{display:flex;flex-direction:column}.next-session-label{font-size:0.85rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;font-family:var(--font-mono)}.next-session-details{font-size:1.1rem;color:var(--text-primary);font-weight:600;margin-top:4px}.robots-fleet{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}.robot-card-compact{background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden;transition:all 0.3s ease;display:flex;flex-direction:column;position:relative}.robot-card-compact:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.4);border-color:rgba(255,255,255,0.2)}.robot-card-compact.robot-arm{border-top:3px solid var(--neon-cyan)}.robot-card-compact.robot-pepper{border-top:3px solid var(--neon-green)}.robot-card-compact.robot-dog{border-top:3px solid var(--neon-orange)}.robot-card-compact:hover.robot-arm{box-shadow:0 8px 24px rgba(41,182,246,0.3)}.robot-card-compact:hover.robot-pepper{box-shadow:0 8px 24px rgba(0,230,118,0.3)}.robot-card-compact:hover.robot-dog{box-shadow:0 8px 24px rgba(255,145,0,0.3)}.robot-image-compact{width:100%;height:150px;display:flex;align-items:center;justify-content:center;font-size:4rem;background:linear-gradient(135deg,var(--bg-secondary) 0%,var(--bg-primary) 100%);position:relative;overflow:hidden}.robot-image-compact img{width:100%;height:100%;object-fit:contain;object-position:center;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3))}.robot-image-compact .robot-icon-fallback{font-size:4rem;line-height:1}.robot-status-led{position:absolute;top:12px;right:12px;width:12px;height:12px;border-radius:50%;box-shadow:0 0 8px currentColor;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.robot-card-compact.robot-arm .robot-status-led{background:var(--neon-cyan);color:var(--neon-cyan)}.robot-card-compact.robot-pepper .robot-status-led{background:var(--neon-green);color:var(--neon-green)}.robot-card-compact.robot-dog .robot-status-led{background:var(--neon-orange);color:var(--neon-orange)}.robot-card-body-compact{padding:16px;display:flex;flex-direction:column;gap:12px}.robot-name-compact{font-size:1.1rem;font-weight:600;margin:0}.robot-card-compact.robot-arm .robot-name-compact{color:var(--neon-cyan)}.robot-card-compact.robot-pepper .robot-name-compact{color:var(--neon-green)}.robot-card-compact.robot-dog .robot-name-compact{color:var(--neon-orange)}.robot-access-btn{padding:10px 16px;border:2px solid;border-radius:8px;background:transparent;font-weight:600;cursor:pointer;transition:all 0.3s ease;text-decoration:none;text-align:center;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:8px}.robot-card-compact.robot-arm .robot-access-btn{border-color:var(--neon-cyan);color:var(--neon-cyan)}.robot-card-compact.robot-arm .robot-access-btn:hover{background:var(--neon-cyan);color:var(--bg-primary);box-shadow:0 0 20px var(--neon-cyan)}.robot-card-compact.robot-pepper .robot-access-btn{border-color:var(--neon-green);color:var(--neon-green)}.robot-card-compact.robot-pepper .robot-access-btn:hover{background:var(--neon-green);color:var(--bg-primary);box-shadow:0 0 20px var(--neon-green)}.robot-card-compact.robot-dog .robot-access-btn{border-color:var(--neon-orange);color:var(--neon-orange)}.robot-card-compact.robot-dog .robot-access-btn:hover{background:var(--neon-orange);color:var(--bg-primary);box-shadow:0 0 20px var(--neon-orange)}.history-chart-container{background:var(--bg-card);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.1)}.history-chart-title{font-size:1.2rem;margin-bottom:16px;color:var(--text-primary);font-weight:600}.dashboard-right-column{display:flex;flex-direction:column;gap:24px}.usage-chart-container{background:var(--bg-card);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.1)}.usage-chart-title{font-size:1.2rem;margin-bottom:16px;color:var(--text-primary);font-weight:600}.sessions-summary{background:var(--bg-card);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.1)}.sessions-summary-title{font-size:1.2rem;margin-bottom:16px;color:var(--text-primary);font-weight:600}.session-summary-item{padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center}.session-summary-item:last-child{border-bottom:none}.session-robot-name{font-weight:600;font-family:var(--font-mono);font-size:0.95rem}.session-stats{text-align:right;font-family:var(--font-mono);font-size:0.85rem;color:var(--text-secondary)}.session-count{display:block;color:var(--text-primary);font-weight:600}.session-minutes{display:block;color:var(--text-muted);font-size:0.75rem;margin-top:4px}@media (max-width:1024px){.dashboard-main-grid{grid-template-columns:1fr}.robots-fleet{grid-template-columns:1fr}}@media (max-width:768px){.robots-fleet{grid-template-columns:1fr}}</style>';
  
  // Build HTML body content
  let bodyContent = '<div class="fade-in"><div class="dashboard-header"><h1>Hi ';
  bodyContent += typeof user !== 'undefined' ? user.name : 'User';
  bodyContent += ', what would you like to do today?</h1></div><div class="dashboard-main-grid"><div class="dashboard-left-column">';
  
  if (typeof nextReservation !== 'undefined' && nextReservation) {
    bodyContent += '<div class="next-session-banner"><div class="next-session-content"><div class="next-session-icon"><i class="fas fa-calendar-check"></i></div><div class="next-session-text"><span class="next-session-label">Next Session</span><span class="next-session-details">';
    bodyContent += new Date(nextReservation.date).toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' });
    bodyContent += ' at ' + nextReservation.startTime + ' (' + nextReservation.duration + ' min)</span></div></div></div>';
  }
  
  bodyContent += '<div><h3 style="margin-bottom:16px;color:var(--text-primary);font-size:1.3rem"><i class="fas fa-robot"></i> The Fleet</h3><div class="robots-fleet">';
  if (typeof robots !== 'undefined' && robots.length > 0) {
    robots.forEach(function(robot) {
      bodyContent += '<div class="robot-card-compact robot-' + robot.id + '"><div class="robot-image-compact" style="background:linear-gradient(135deg,' + robot.color + '22 0%,' + robot.color + '44 100%)">';
      if (robot.image) {
        const imgOnError = 'this.style.display=\'none\';this.nextElementSibling.style.display=\'block\'';
        bodyContent += '<img src="' + escapeAttr(robot.image) + '" alt="' + escapeAttr(robot.displayName) + '" onerror="' + imgOnError + '"><span class="robot-icon-fallback" style="display:none">' + (robot.icon || 'ðŸ¤–') + '</span>';
      } else {
        bodyContent += '<span class="robot-icon-fallback">' + (robot.icon || 'ðŸ¤–') + '</span>';
      }
      bodyContent += '<div class="robot-status-led"></div></div><div class="robot-card-body-compact"><h3 class="robot-name-compact">' + escapeAttr(robot.displayName) + '</h3><a href="/robots/' + robot.id + '" class="robot-access-btn"><i class="fas fa-play"></i> Access</a></div></div>';
    });
  } else {
    bodyContent += '<div style="grid-column:1/-1;padding:24px;text-align:center;color:var(--text-muted)"><i class="fas fa-info-circle" style="font-size:2rem;margin-bottom:12px;display:block"></i><p>You don\'t have access to any robots. Contact the administrator.</p></div>';
  }
  bodyContent += '</div></div><div class="history-chart-container"><h3 class="history-chart-title"><i class="fas fa-chart-line"></i> Session History (Last 7 days)</h3><canvas id="historyChart" style="max-height:250px"></canvas></div></div><div class="dashboard-right-column"><div class="usage-chart-container"><h3 class="usage-chart-title"><i class="fas fa-chart-pie"></i> Total Usage by Robot</h3><canvas id="usageChart" style="max-height:250px"></canvas></div><div class="sessions-summary"><h3 class="sessions-summary-title"><i class="fas fa-list"></i> Sessions Summary</h3>';
  if (typeof chartData !== 'undefined' && chartData.length > 0) {
    chartData.forEach(function(data) {
      bodyContent += '<div class="session-summary-item"><span class="session-robot-name" style="color:' + data.color + '">' + escapeAttr(data.robot) + '</span><div class="session-stats"><span class="session-count">' + data.sessions + ' sessions</span><span class="session-minutes">' + data.minutes + ' min total</span></div></div>';
    });
  } else {
    bodyContent += '<p style="color:var(--text-muted);text-align:center;padding:20px">No session data yet.</p>';
  }
  bodyContent += '</div></div></div></div>';
  
  // Build JavaScript content - only data injection, chart code is in separate file
  let jsContent = '<script>';
  if (typeof historyData !== 'undefined' && historyData.length > 0) {
    jsContent += 'window.historyData = ' + historyDataJson + ';';
  } else {
    jsContent += 'window.historyData = [];';
  }
  if (typeof chartData !== 'undefined' && chartData.length > 0) {
    jsContent += 'window.chartData = ' + chartDataJson + ';';
  } else {
    jsContent += 'window.chartData = [];';
  }
  jsContent += '</script>';
%>
<%- include('../layout', { 
  title: 'Dashboard - Robot Control',
  currentPage: 'dashboard',
  dashboardStyles: cssContent,
  dashboardBody: bodyContent,
  dashboardScripts: jsContent
}) %>
