<%- include('../layout', { 
  title: 'Reservations - Robot Control',
  currentPage: 'reservations',
  body: `
    <div class="fade-in">
      <h1 style="text-align: center; margin-bottom: 32px;">Reservations</h1>
      
      <!-- New Reservation Form -->
      <div class="card" style="margin-bottom: 32px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-plus-circle"></i> New Reservation</h2>
        <form id="reservationForm">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
            <div class="form-group">
              <label class="form-label" for="robot">Robot</label>
              <select id="robot" name="robot" class="form-control" required>
                <option value="">Select a robot</option>
                ${typeof robots !== 'undefined' ? robots.map(robot => `
                  <option value="${robot.id}">${robot.displayName}</option>
                `).join('') : ''}
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="date">Date</label>
              <input type="date" id="date" name="date" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="startTime">Time</label>
              <input type="time" id="startTime" name="startTime" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="duration">Duration</label>
              <select id="duration" name="duration" class="form-control" required>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="120">2 hours</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button type="submit" class="btn-neon btn-neon-cyan">
              <i class="fas fa-calendar-plus"></i> Create Reservation
            </button>
            <button type="button" id="checkAvailability" class="btn-neon" style="border-color: var(--neon-green); color: var(--neon-green);">
              <i class="fas fa-search"></i> Check Availability
            </button>
          </div>
        </form>
        
        <div id="availabilityResult" style="margin-top: 20px; display: none;"></div>
      </div>
      
      <!-- Upcoming Reservations -->
      <div class="card" style="margin-bottom: 32px;">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-calendar-check"></i> Upcoming Reservations</h2>
        ${typeof upcomingReservations !== 'undefined' && upcomingReservations.length > 0 ? `
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Robot</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Duration</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${upcomingReservations.map(reservation => `
                  <tr>
                    <td>${reservation.robot}</td>
                    <td>${new Date(reservation.date).toLocaleDateString('en-US')}</td>
                    <td>${reservation.startTime}</td>
                    <td>${reservation.duration} min</td>
                    <td>
                      <button class="btn-neon" style="padding: 6px 12px; font-size: 0.9rem; border-color: #ff6b6b; color: #ff6b6b;" onclick="deleteReservation('${reservation._id}')">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-muted">You have no upcoming reservations.</p>'}
      </div>
      
      <!-- Past Reservations -->
      <div class="card">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-history"></i> Past Reservations</h2>
        ${typeof pastReservations !== 'undefined' && pastReservations.length > 0 ? `
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Robot</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Duration</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${pastReservations.map(reservation => `
                  <tr>
                    <td>${reservation.robot}</td>
                    <td>${new Date(reservation.date).toLocaleDateString('en-US')}</td>
                    <td>${reservation.startTime}</td>
                    <td>${reservation.duration} min</td>
                    <td><span class="text-muted">${reservation.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-muted">No past reservations.</p>'}
      </div>
    </div>
    
    <script>
      // Manejar envÃ­o de formulario
      document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/reservations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Reservation created successfully');
            location.reload();
          } else {
            alert(result.error || 'Error creating reservation');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error creating reservation');
        }
      });
      
      // Verificar disponibilidad
      document.getElementById('checkAvailability').addEventListener('click', async () => {
        const robot = document.getElementById('robot').value;
        const date = document.getElementById('date').value;
        
        if (!robot || !date) {
          alert('Please select a robot and a date');
          return;
        }
        
        try {
          const response = await fetch(\`/reservations/check-availability?robot=\${robot}&date=\${date}\`);
          const result = await response.json();
          
          const resultDiv = document.getElementById('availabilityResult');
          resultDiv.style.display = 'block';
          
          if (result.reservations && result.reservations.length > 0) {
            resultDiv.innerHTML = \`
              <div style="background: rgba(255,193,7,0.2); border: 1px solid rgba(255,193,7,0.5); border-radius: 8px; padding: 16px;">
                <h4 style="margin-bottom: 12px; color: #ffc107;"><i class="fas fa-info-circle"></i> Occupied Times:</h4>
                <ul style="margin: 0; padding-left: 20px;">
                  \${result.reservations.map(r => \`<li>\${r.startTime} - \${r.duration} min</li>\`).join('')}
                </ul>
              </div>
            \`;
          } else {
            resultDiv.innerHTML = \`
              <div style="background: rgba(0,230,118,0.2); border: 1px solid rgba(0,230,118,0.5); border-radius: 8px; padding: 16px; color: #00E676;">
                <i class="fas fa-check-circle"></i> No reservations on this date. The robot is available.
              </div>
            \`;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error checking availability');
        }
      });
      
      // Delete reservation
      async function deleteReservation(id) {
        if (!confirm('Are you sure you want to delete this reservation?')) return;
        
        try {
          const response = await fetch(\`/reservations/\${id}\`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Reservation deleted successfully');
            location.reload();
          } else {
            alert(result.error || 'Error deleting reservation');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error deleting reservation');
        }
      }
    </script>
  `
}) %>

