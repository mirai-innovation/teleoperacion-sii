<%- include('../layout', { 
  title: 'User Management - Admin',
  currentPage: 'admin',
  body: `
    <div class="fade-in">
      <h1 style="margin-bottom: 32px;"><i class="fas fa-users-cog"></i> User Management</h1>
      
      ${typeof users !== 'undefined' && users.length > 0 ? `
        <div class="card">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Robot Access</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => `
                  <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>
                      <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; background: ${user.role === 'admin' ? 'rgba(41,182,246,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${user.role === 'admin' ? '#29B6F6' : '#fff'};">
                        ${user.role === 'admin' ? 'Admin' : 'User'}
                      </span>
                    </td>
                    <td>
                      <span id="status-${user._id}" style="padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; background: ${user.isActive ? 'rgba(0,230,118,0.2)' : 'rgba(255,107,107,0.2)'}; color: ${user.isActive ? '#00E676' : '#ff6b6b'};">
                        ${user.isActive ? 'Active' : 'Inactive'}
                      </span>
                    </td>
                    <td>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${typeof robots !== 'undefined' ? robots.map(robot => {
                          const hasAccess = user.allowed_robots && user.allowed_robots.includes(robot.id);
                          return `
                            <button 
                              class="btn-neon" 
                              style="padding: 4px 8px; font-size: 0.75rem; border-color: ${hasAccess ? robot.color : 'rgba(255,255,255,0.3)'}; color: ${hasAccess ? robot.color : 'rgba(255,255,255,0.5)'}; background: ${hasAccess ? robot.color + '22' : 'transparent'};"
                              onclick="toggleRobotAccess('${user._id}', '${robot.id}')"
                            >
                              ${robot.icon || 'ðŸ¤–'} ${robot.name}
                            </button>
                          `;
                        }).join('') : ''}
                      </div>
                    </td>
                    <td>
                      <div style="display: flex; gap: 8px;">
                        <button 
                          class="btn-neon" 
                          style="padding: 6px 12px; font-size: 0.85rem; border-color: ${user.isActive ? '#ff6b6b' : '#00E676'}; color: ${user.isActive ? '#ff6b6b' : '#00E676'};"
                          onclick="toggleUserActive('${user._id}')"
                        >
                          <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i> ${user.isActive ? 'Deactivate' : 'Activate'}
                        </button>
                        ${user.role !== 'admin' ? `
                          <button 
                            class="btn-neon" 
                            style="padding: 6px 12px; font-size: 0.85rem; border-color: #ff6b6b; color: #ff6b6b;"
                            onclick="deleteUser('${user._id}')"
                          >
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        ` : ''}
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      ` : '<p class="text-muted">No registered users.</p>'}
    </div>
    
    <script>
      // Toggle robot access
      async function toggleRobotAccess(userId, robotId) {
        try {
          const response = await fetch(\`/admin/users/\${userId}/toggle-robot\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ robotId })
          });
          
          const result = await response.json();
          
          if (result.success) {
            location.reload();
          } else {
            alert(result.error || 'Error changing access');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error changing access');
        }
      }
      
      // Toggle active/inactive status
      async function toggleUserActive(userId) {
        try {
          const response = await fetch(\`/admin/users/\${userId}/toggle-active\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          
          if (result.success) {
            location.reload();
          } else {
            alert(result.error || 'Error changing status');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error changing status');
        }
      }
      
      // Delete user
      async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
        
        try {
          const response = await fetch(\`/admin/users/\${userId}\`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('User deleted successfully');
            location.reload();
          } else {
            alert(result.error || 'Error deleting user');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error deleting user');
        }
      }
    </script>
  `
}) %>

